$LOAD_PATH << File.expand_path(File.dirname(__FILE__))

require 'lib/postview'
require 'net/ftp'
require 'readline'

require 'rake/testtask'
require 'rake/packagetask'


# Show text message in console.
def banner(message)
  printf "\n%s\n", Postview
  printf "\n%s\n\n", message
end

# Prompt for values.
def prompt(label, default = nil)
  while true
    printf((default ? "%s [%s]: " : "%s: "), "#{label}", "#{default}")
    value = $stdin.readline.chomp.strip
    value = default if value.empty?
    return value unless value.nil? || value.to_s.empty?
  end
end

# Build default settings file and load.
def settings
  Postview::Settings.build_default_file
  Postview::Settings.load
end

# Build and load the resource file for FTP connection.
def netrc
  begin
    @netrc ||= File.readlines(File.join(ENV['HOME'],".netrc"))
  rescue Errno::ENOENT => message
    puts <<-end_message.gsub(/^[ ]{6}/,'')
      #{message}.
      Please create the .netrc file in your home.
      echo "\
      machine #{settings.site[:host]}
        login <username>
        password <password>
      " >> #{ENV['HOME']}/.netrc
    end_message
    exit 1
  end
  match ||= @netrc.to_s.match(/machine (.*?)[\n ]login (.*?)[\n ]password (.*?)[\n ].*?/m)
  { :machine => match[1].strip, :login => match[2].strip, :password => match[3].strip }
end

# Synchronize directory
def sync(directory, destination = nil)
  origin        = settings.directories[directory]
  destination ||= File.join(settings.site[:directory], settings.directories[directory])
  posts         = settings.build_finder_for(directory).all_posts

  $stdout.puts ">> Connecting to #{netrc[:machine]} ..."

  Net::FTP.open(netrc[:machine]) do |ftp|
    ftp.login netrc[:login], netrc[:password]

    $stdout.puts ">> Logged as #{netrc[:login]} ..."

    $stdout.puts ">> Accessing #{destination} ..."

    ftp.chdir destination

    posts.each do |post|
      $stdout.puts ">> Copying #{post} ..."
      ftp.putbinaryfile(File.join(origin, post.file))
    end

    $stdout.puts ">> Synchronization for #{directory} is done."
  end
end

Rake::TestTask.new

Rake::PackageTask.new Postview.name.downcase, Postview.version do |pkg|
  pkg.need_zip  = true
  pkg.package_files.include(
    "lib/**/*.rb",
    "config/*.*",
    "views/*.erb",
    "public/**/*"
  )
end

desc "Build settings file."
task :settings do
  File.open(Postview::SETTINGS, "r+") do |file|
    new_settings = {}
    $stdout.puts ">> Site ...\n"
    new_settings[:site] = {
      :title     => prompt("Title", settings.site[:title]),
      :subtitle  => prompt("Subtitle", settings.site[:subtitle]),
      :author    => prompt("Author name", settings.site[:author]),
      :email     => prompt("Email", settings.site[:email]),
      :host      => prompt("Host", settings.site[:host]),
      :directory => prompt("Directory", settings.site[:directory])
    }
    $stdout.puts ">> Directories ...\n"
    new_settings[:directories] = {
      :posts   => prompt("Posts", settings.directories[:posts]),
      :archive => prompt("Archive", settings.directories[:archive]),
      :drafts  => prompt("Drafts", settings.directories[:drafts])
    }
    $stdout.puts ">> Mapping ...\n"
    new_settings[:mapping] = {
      :root    => prompt("Root", settings.mapping[:root]),
      :posts   => prompt("Posts", settings.mapping[:posts]),
      :tags    => prompt("Tags", settings.mapping[:tags]),
      :archive => prompt("Archive", settings.mapping[:archive]),
      :drafts  => prompt("Drafts", settings.mapping[:drafts]),
      :search  => prompt("Search", settings.mapping[:search]),
      :about   => prompt("About", settings.mapping[:about])
    }
    file << new_settings.to_yaml
    $stdout.puts ">> Settings are done."
  end
end


desc "Create rackup file."
task :config do
  $stdout.puts ">> Creating config.ru file ..."
  File.open("#{Postview::ROOT}/config.ru", "w+") do |rackup|
    rackup << <<-end_rackup.gsub(/^      /,'')
      require 'lib/postview'

      log = File.open("tmp/postview.log", "w+")

      $stdout.reopen(log)
      $stderr.reopen(log)

      run Postview::Application
    end_rackup
  end
end

namespace :config do
  desc "Create rackup file vendoring all requirements."
  task :vendor do
    puts "Vendor"
  end
end

desc <<-end_desc.gsub(/^[ ]{2}/,'')
  Create new post in #{settings.directory_for(:posts)}.
  For edit posts, set environment variable EDITOR or VISUAL. Otherwise,
  pass editor="<your favorite editor command and arguments>".

  Example:

  $ rake post editor="gvim -f"

  Or use directory argument for create a post in other directory.

  $ rake post[other/path/for/new/post]
end_desc
task :post, [:directory] do |spec, args|
  banner "New post. Type all attributes for new post.\n"
  path = if args.directory
           if settings.directories.has_key? args.directory.to_sym 
             settings.directory_for(args.directory.to_sym)
           else
             args.directory
           end
         else
           settings.directory_for(:drafts)
         end
  post = Postage::Post.new :title        => prompt("Post title"),
                           :publish_date => prompt("Publish date", Date.today),
                           :tags         => prompt("Tags separated by spaces").split(' '),
                           :filter       => :markdown,
                           :content      => <<-end_content.gsub(/^[ ]{29}/,'')
                             Tanks for use #{Postview}.
                             Input here the content of your post.
                           end_content

  begin
    post.build_file
    post.create_into(path)
  rescue Errno::ENOENT => message
    $stderr.puts message
    $stderr.puts "Try create path #{args.directory}."
    exit 1
  end

  printf "%s\n", "The post '#{post.title}' was created in '#{path}/#{post.file}'."

  editor = ENV['editor'] || ENV['EDITOR'] || ENV['VISUAL'] || 'none'
  if prompt("Edit post using '#{editor}'?", "y") =~ /y/i
    if editor
      sh "#{editor} #{path}/#{post.file}"
    else
      printf "%s", "Editor not specified."
    end
  end

  $stdout.puts ">> Post done."
end

namespace :sync do
  settings.directories.keys.each do |dirname|
    desc "Synchronize #{dirname}."
    task dirname, [:destination] do |spec,args|
      banner "Synchronize #{dirname} directory."
      sync(dirname, args.destination)
    end
  end

  desc "Synchronize all directories."
  task :all => settings.directories.keys
end

desc "#{Postview} setup."
task :setup do |spec|
  banner "Setup settings and rackup file."
  Rake::Task["settings"].invoke
  Rake::Task["config"].invoke
end

task :default => :setup

